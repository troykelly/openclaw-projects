# Basic docker-compose.yml for openclaw-projects (Issue #528)
#
# This is for localhost/behind-proxy deployment without TLS.
# Uses published images from ghcr.io.
#
# Usage:
#   cp .env.example .env
#   # Edit .env and set required values (POSTGRES_PASSWORD, COOKIE_SECRET, S3_SECRET_KEY)
#   docker compose up -d
#
# The migrate service will run once on startup and exit.
# API will be available on API_PORT (default 3000)
# Frontend will be available on FRONTEND_PORT (default 8080)

name: openclaw-projects

services:
  # =============================================================================
  # Database (PostgreSQL with TimescaleDB, pgvector, pg_cron)
  # =============================================================================
  db:
    image: ghcr.io/troykelly/openclaw-projects-db:latest
    container_name: openclaw-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-openclaw}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      POSTGRES_DB: ${POSTGRES_DB:-openclaw}
    command:
      - postgres
      - -c
      - shared_preload_libraries=timescaledb,pg_cron
      - -c
      - cron.database_name=${POSTGRES_DB:-openclaw}
    # Note: PostgreSQL 18+ uses versioned subdirectories (e.g., /18/docker)
    # Mount at /var/lib/postgresql to allow proper version management
    volumes:
      - db_data:/var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER:-openclaw} -d $${POSTGRES_DB:-openclaw}"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    # PostgreSQL requires more shared memory than Docker's default 64MB
    shm_size: 256mb
    # Container hardening
    # Note: PostgreSQL requires more capabilities than other services for initialization
    # We keep no-new-privileges but don't drop all capabilities
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M

  # =============================================================================
  # SeaweedFS (S3-compatible object storage)
  # =============================================================================
  seaweedfs:
    image: chrislusf/seaweedfs:4.09
    container_name: openclaw-seaweedfs
    restart: unless-stopped
    entrypoint: ["/docker-entrypoint-s3.sh"]
    environment:
      # S3 authentication credentials (must match API configuration)
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-openclaw}
      S3_SECRET_KEY: ${S3_SECRET_KEY:?S3_SECRET_KEY is required}
      # Volume configuration
      SEAWEEDFS_VOLUME_SIZE_LIMIT_MB: ${SEAWEEDFS_VOLUME_SIZE_LIMIT_MB:-1000}
      SEAWEEDFS_VOLUME_MAX: ${SEAWEEDFS_VOLUME_MAX:-10}
    ports:
      # Bind to localhost only for security (basic compose runs behind proxy)
      - "[::1]:${SEAWEEDFS_PORT:-8333}:8333"       # IPv6 (preferred)
      - "127.0.0.1:${SEAWEEDFS_PORT:-8333}:8333"  # IPv4 fallback
    volumes:
      - seaweedfs_data:/data
      - ./docker/seaweedfs/s3.json.template:/etc/seaweedfs/s3.json.template:ro
      - ./docker/seaweedfs/entrypoint.sh:/docker-entrypoint-s3.sh:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://127.0.0.1:9333/cluster/status"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 30s
    # Container hardening
    # Note: SeaweedFS entrypoint needs CHOWN for /data ownership and
    # SETGID/SETUID for su-exec user switching
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 256M

  # =============================================================================
  # Database Migrations (runs once and exits)
  # =============================================================================
  migrate:
    image: ghcr.io/troykelly/openclaw-projects-migrate:latest
    container_name: openclaw-migrate
    restart: "no"
    depends_on:
      db:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-openclaw}:${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}@db:5432/${POSTGRES_DB:-openclaw}?sslmode=disable
    command:
      - -path
      - /migrations
      - -database
      - postgresql://${POSTGRES_USER:-openclaw}:${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}@db:5432/${POSTGRES_DB:-openclaw}?sslmode=disable
      - up
    # Container hardening
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

  # =============================================================================
  # API Server (Fastify)
  # =============================================================================
  api:
    image: ghcr.io/troykelly/openclaw-projects-api:latest
    container_name: openclaw-api
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      seaweedfs:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    environment:
      NODE_ENV: production
      HOST: "::"
      PORT: 3000
      PUBLIC_BASE_URL: ${PUBLIC_BASE_URL:-http://localhost:3000}
      COOKIE_SECRET: ${COOKIE_SECRET:?COOKIE_SECRET is required}
      # Database connection
      PGHOST: db
      PGPORT: 5432
      PGUSER: ${POSTGRES_USER:-openclaw}
      PGPASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      PGDATABASE: ${POSTGRES_DB:-openclaw}
      # S3-compatible storage (SeaweedFS)
      S3_ENDPOINT: http://seaweedfs:8333
      S3_BUCKET: ${S3_BUCKET:-openclaw}
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-openclaw}
      S3_SECRET_KEY: ${S3_SECRET_KEY:?S3_SECRET_KEY is required}
      S3_FORCE_PATH_STYLE: "true"
      # Optional: Postmark email (magic links)
      POSTMARK_FROM_EMAIL: ${POSTMARK_FROM_EMAIL:-${POSTMARK_FROM:-}}
      POSTMARK_REPLY_TO: ${POSTMARK_REPLY_TO:-}
      POSTMARK_MESSAGE_STREAM: ${POSTMARK_MESSAGE_STREAM:-outbound}
      POSTMARK_TRANSACTIONAL_TOKEN: ${POSTMARK_TRANSACTIONAL_TOKEN:-}
      # Authentication for OpenClaw plugin requests
      # At least one of: OPENCLAW_PROJECTS_AUTH_SECRET, _FILE, or _COMMAND must be set
      # OR set OPENCLAW_PROJECTS_AUTH_DISABLED=true (not recommended for production)
      OPENCLAW_PROJECTS_AUTH_SECRET: ${OPENCLAW_PROJECTS_AUTH_SECRET:-}
      OPENCLAW_PROJECTS_AUTH_SECRET_FILE: ${OPENCLAW_PROJECTS_AUTH_SECRET_FILE:-}
      OPENCLAW_PROJECTS_AUTH_SECRET_COMMAND: ${OPENCLAW_PROJECTS_AUTH_SECRET_COMMAND:-}
      OPENCLAW_PROJECTS_AUTH_DISABLED: ${OPENCLAW_PROJECTS_AUTH_DISABLED:-false}
      # Embedding provider
      EMBEDDING_PROVIDER: ${EMBEDDING_PROVIDER:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENAI_API_KEY_FILE: ${OPENAI_API_KEY_FILE:-}
      OPENAI_API_KEY_COMMAND: ${OPENAI_API_KEY_COMMAND:-}
      VOYAGERAI_API_KEY: ${VOYAGERAI_API_KEY:-}
      VOYAGERAI_API_KEY_FILE: ${VOYAGERAI_API_KEY_FILE:-}
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      GEMINI_API_KEY_FILE: ${GEMINI_API_KEY_FILE:-}
      # OAuth integration (Microsoft 365 / Google)
      # Required for contacts, email, drive/files, calendar features
      # See docs/guides/oauth-setup.md for credential setup
      MS365_CLIENT_ID: ${MS365_CLIENT_ID:-}
      MS365_CLIENT_SECRET: ${MS365_CLIENT_SECRET:-}
      AZURE_TENANT_ID: ${AZURE_TENANT_ID:-}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      OAUTH_REDIRECT_URI: ${OAUTH_REDIRECT_URI:-}
      OAUTH_TOKEN_ENCRYPTION_KEY: ${OAUTH_TOKEN_ENCRYPTION_KEY:-}
      # SMS (Twilio) - optional
      TWILIO_ACCOUNT_SID: ${TWILIO_ACCOUNT_SID:-}
      TWILIO_AUTH_TOKEN: ${TWILIO_AUTH_TOKEN:-}
      TWILIO_FROM_NUMBER: ${TWILIO_FROM_NUMBER:-}
      # Rate limiting
      RATE_LIMIT_MAX: ${RATE_LIMIT_MAX:-100}
      RATE_LIMIT_WINDOW_MS: ${RATE_LIMIT_WINDOW_MS:-60000}
      # Webhook security
      WEBHOOK_IP_WHITELIST_DISABLED: ${WEBHOOK_IP_WHITELIST_DISABLED:-false}
      # OpenClaw integration
      OPENCLAW_GATEWAY_URL: ${OPENCLAW_GATEWAY_URL:-}
      OPENCLAW_HOOK_TOKEN: ${OPENCLAW_HOOK_TOKEN:-}
      # File upload
      MAX_FILE_SIZE_BYTES: ${MAX_FILE_SIZE_BYTES:-10485760}
    ports:
      - "[::1]:${API_PORT:-3000}:3000"       # IPv6 (preferred)
      - "127.0.0.1:${API_PORT:-3000}:3000"  # IPv4 fallback
    healthcheck:
      test: ["CMD-SHELL", "node -e \"fetch('http://127.0.0.1:3000/health').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))\""]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 15s
    # Container hardening
    read_only: true
    tmpfs:
      - /tmp:mode=1777,size=64M
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 256M

  # =============================================================================
  # Frontend App (React SPA served via static server)
  # =============================================================================
  app:
    image: ghcr.io/troykelly/openclaw-projects-app:latest
    container_name: openclaw-app
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    environment:
      # API proxy configuration for nginx
      # Nginx proxies /api/* requests to the API container
      API_HOST: api
      API_PORT: "3000"
    ports:
      - "[::1]:${FRONTEND_PORT:-8080}:8080"       # IPv6 (preferred)
      - "127.0.0.1:${FRONTEND_PORT:-8080}:8080"  # IPv4 fallback
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O /dev/null http://127.0.0.1:8080/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s
    # Container hardening
    read_only: true
    tmpfs:
      - /tmp:mode=1777,size=32M
      - /var/cache/nginx:mode=1777,size=32M
      - /var/run:mode=1777,size=8M
      # Nginx entrypoint writes processed templates here
      - /etc/nginx/conf.d:mode=1777,size=1M
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 64M

volumes:
  db_data:
  seaweedfs_data:
