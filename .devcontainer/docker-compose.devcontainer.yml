services:
  workspace:
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile
    env_file:
      - path: ../.env
        required: false
    environment:
      # S3-compatible storage via SeaweedFS
      S3_ENDPOINT: http://seaweedfs:8333
      S3_BUCKET: openclaw
      S3_REGION: us-east-1
      S3_ACCESS_KEY: openclaw
      S3_SECRET_KEY: openclaw
      S3_FORCE_PATH_STYLE: "true"
      # Claude Code agent teams (experimental) — enables parallel coordination
      CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS: "1"
      # Nominatim (reverse geocoding for geo-contextual search)
      NOMINATIM_URL: http://nominatim:8080
    volumes:
      - ..:/workspaces/openclaw-projects:cached
      # ┌─────────────────────────────────────────────────────────────────┐
      # │ Docker-outside-of-Docker (DooD) Security Model                  │
      # ├─────────────────────────────────────────────────────────────────┤
      # │ This mount exposes the host Docker daemon to the devcontainer   │
      # │ via /var/run/docker.sock. The DooD feature's socat proxy        │
      # │ creates proper group permissions (docker group, mode 660) for   │
      # │ non-root users. See: https://github.com/devcontainers/features/issues/444
      # │                                                                  │
      # │ SECURITY IMPLICATIONS:                                           │
      # │ • Any code in this container has root-equivalent host access    │
      # │ • Can spawn privileged containers and bind-mount host paths     │
      # │ • Malicious npm packages can compromise the host system         │
      # │                                                                  │
      # │ This is standard practice for devcontainers (VS Code, GitHub    │
      # │ Codespaces all use DooD) and accepted for local development     │
      # │ environments. CI runners use ephemeral VMs where socket         │
      # │ exposure is isolated and standard.                              │
      # │                                                                  │
      # │ MITIGATION:                                                      │
      # │ • No --privileged flag used in any container                    │
      # │ • CI runs in ephemeral GitHub Actions VMs (isolated)            │
      # │ • Production deployments do NOT expose Docker socket            │
      # │ • Review dependencies and only use trusted packages             │
      # │                                                                  │
      # │ For details: docs/development/devcontainer-security.md          │
      # └─────────────────────────────────────────────────────────────────┘
      - /var/run/docker.sock:/var/run/docker-host.sock
    # DooD feature entrypoint is NOT auto-merged with Docker Compose.
    # When the docker-outside-of-docker feature is installed (local dev via
    # VS Code / devcontainer CLI), docker-init.sh starts the socat proxy
    # before exec'ing into `command`. In CI, features aren't applied, so
    # the script won't exist — fall back to exec'ing the command directly.
    entrypoint: ["/bin/sh", "-c", "if [ -x /usr/local/share/docker-init.sh ]; then exec /usr/local/share/docker-init.sh \"$$@\"; else exec \"$$@\"; fi", "--"]
    command: ["sleep", "infinity"]
    depends_on:
      postgres:
        condition: service_healthy
      seaweedfs:
        condition: service_healthy

  postgres:
    build:
      context: ..
      dockerfile: docker/postgres/Dockerfile
    environment:
      POSTGRES_USER: openclaw
      POSTGRES_PASSWORD: openclaw
      POSTGRES_DB: openclaw
    command:
      - postgres
      - -c
      - shared_preload_libraries=timescaledb,pg_cron
      - -c
      - cron.database_name=openclaw
    volumes:
      - openclaw_projects_postgres_data:/var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U openclaw -d openclaw"]
      interval: 5s
      timeout: 5s
      retries: 10

  seaweedfs:
    image: chrislusf/seaweedfs:4.09
    command: "server -s3 -s3.port=8333 -master.volumeSizeLimitMB=100 -volume.max=10"
    environment:
      # SeaweedFS S3 credentials (used by the filer/s3 gateway)
      WEED_S3_AUTH_ENABLED: "false"
    ports:
      - "[::1]:8333:8333"       # IPv6 (preferred)
      - "127.0.0.1:8333:8333"  # IPv4 fallback
      - "[::1]:9333:9333"       # IPv6 (preferred)
      - "127.0.0.1:9333:9333"  # IPv4 fallback
    volumes:
      - openclaw_projects_seaweedfs_data:/data
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://127.0.0.1:9333/cluster/status"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 30s

  nominatim:
    image: mediagis/nominatim:4.4
    environment:
      PBF_URL: https://download.geofabrik.de/australia-oceania/australia-latest.osm.pbf
      REPLICATION_URL: https://download.geofabrik.de/australia-oceania/australia-updates/
      NOMINATIM_PASSWORD: openclaw
    volumes:
      - openclaw_projects_nominatim_data:/var/lib/postgresql/14/main
    ports:
      - "[::1]:8080:8080"
      - "127.0.0.1:8080:8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/status"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 600s

volumes:
  openclaw_projects_postgres_data:
  openclaw_projects_seaweedfs_data:
  openclaw_projects_nominatim_data:
