# Omnibus Fix: Issues #1830, #1831, #1828, #1881, #1882, #1883, #1884

**Date:** 2026-02-26
**Status:** Approved
**PR scope:** Single omnibus PR covering all 7 issues

---

## Issue Summary

| Issue | Title | Root Cause |
|-------|-------|-----------|
| #1830 | `relationship_set` fails with contact names | `resolveContact` namespace-scopes lookups; contacts in `default` ns invisible to plugin sending `troy` ns |
| #1831 | `contact_get` / `namespace_members` show "undefined" | Plugin field mapping mismatch or API response shape issue |
| #1828 | `memory_forget` returns short IDs but gateway requires full UUID | Candidate list must show full UUIDs (current code may already do this — verify) |
| #1881 | `contact_create` doesn't persist email/phone as endpoints | `POST /api/contacts` ignores `endpoints` array in body |
| #1882 | `todo_list` project_id filter ignored | `GET /api/work-items` doesn't parse `parent_work_item_id` query param |
| #1883 | `namespace_members` endpoint 404 | `GET /api/namespaces/:ns` exists but M2M auth or routing issue causes 404 |
| #1884 | `file_share` returns 403 | Ownership check uses `uploaded_by !== email`; M2M agent identity doesn't match |

---

## Fixes

### #1830 — resolveContact cross-namespace fallback

**File:** `src/api/relationships/service.ts` (lines 440-499)

When the namespace-scoped UUID or name lookup returns no results, fall back to un-scoped lookup. The namespace-scoped query remains the preferred match (tried first). The fallback searches all contacts the caller could reasonably access.

This applies to both UUID lookups (line 448-460) and name lookups (line 462-496).

### #1831 — contact_get and namespace_members "undefined"

**File:** `packages/openclaw-plugin/src/register-openclaw.ts`

**contact_get (lines 2388-2416):** Verify API response shape matches plugin expectations. The plugin reads `contact.display_name` etc. from `response.data`. If the response wraps the contact in a container, all fields resolve to `undefined`. Add defensive logging and field extraction.

**namespace_members (lines 3924-3944):** Investigate why `GET /api/namespaces/:ns` returns 404 for M2M tokens. The endpoint exists (server.ts:1022) and M2M tokens skip user-level grant checks. Possible causes: auth identity resolution failure, route ordering conflict, or apiClient request construction issue. Fix the root cause and add fallback error handling.

### #1828 — memory_forget full UUIDs

**File:** `packages/openclaw-plugin/src/register-openclaw.ts` (line 2009)

Current code uses `m.id` from the search API, which returns `id::text` (full UUID). Verify this works correctly. If truncation occurs anywhere, fix the formatting to always show full UUIDs. The OpenClaw gateway enforces `format: "uuid"` and will not change.

### #1881 — contact_create endpoints

**File:** `src/api/server.ts` (lines 6495-6632)

Add `endpoints` support to `POST /api/contacts`:
1. Accept optional `endpoints: Array<{ type: string; value: string; metadata?: object }>` in body
2. Validate endpoint types and values
3. Insert `contact_endpoint` records in the same transaction (after contact creation, before COMMIT)
4. Follow the same pattern as `POST /api/contacts/bulk` (line 6704)
5. Return endpoints in the response

### #1882 — todo_list parent_work_item_id filter

**File:** `src/api/server.ts` (lines 3275-3321)

Parse `parent_work_item_id` from query params. When provided, add `AND parent_id = $N` to the WHERE clause. Validate it's a UUID format before using.

### #1883 — namespace_members 404 investigation

**Files:** `src/api/server.ts` (lines 1022-1059) + plugin

The endpoint `GET /api/namespaces/:ns` exists and M2M tokens bypass the user grant check. Investigation needed:
1. Check if `getAuthIdentity` returns a valid identity for M2M tokens on this route
2. Check for route ordering conflicts
3. Verify the plugin passes auth headers correctly via `reqOpts()`
4. Add defensive handling and logging

### #1884 — file_share M2M access

**File:** `src/api/server.ts` (lines 4992-5057)

The ownership check at line 5033 compares `metadata.uploaded_by` with the session email. For M2M tokens, the "email" is the agent identity, not the file uploader.

Fix: For M2M tokens, allow sharing if the file is in the same namespace as the caller. This is consistent with how other endpoints handle M2M authorization (namespace-scoped access rather than per-user ownership).

---

## Team Structure

Three parallel work streams, each in its own worktree:

| Stream | Issues | Files |
|--------|--------|-------|
| API fixes | #1830, #1881, #1882, #1884 | `src/api/server.ts`, `src/api/relationships/service.ts` |
| Plugin fixes | #1831, #1828 | `packages/openclaw-plugin/src/register-openclaw.ts` |
| Namespace endpoint | #1883 | Investigation + fix across API and plugin |

All streams merge into a single omnibus branch for one PR.

---

## Testing

Each fix requires:
1. Unit tests for the specific behavior
2. Integration tests against real PostgreSQL where applicable
3. Verification that existing tests still pass

## OpenAPI

Any changes to API input/output shapes must update the relevant OpenAPI specs in `src/api/openapi/`.
