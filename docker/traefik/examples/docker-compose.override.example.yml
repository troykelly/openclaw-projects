# docker-compose.override.example.yml
#
# Example docker-compose override file for adding custom services and Traefik routes.
# Copy this file to docker-compose.override.yml in your project root and modify as needed.
#
# This file demonstrates two extension patterns:
#   1. File Provider: Mount custom YAML configs for additional routes (recommended)
#   2. Docker Labels: Services register routes via Traefik labels
#
# HOST NETWORKING NOTE:
#   Traefik runs with network_mode: host so it can see real client IPs.
#   This means Traefik is NOT on the Docker bridge network, so it cannot reach
#   services by their Docker hostname. Instead:
#
#   - Custom services must publish ports to localhost (dual-stack recommended)
#   - Route configs use http://SERVICE_HOST:PORT (not http://container-name:PORT)
#   - Inter-service communication (between non-Traefik containers) still uses
#     Docker hostnames normally since those containers are on the bridge network
#
# Usage:
#   cp docker/traefik/examples/docker-compose.override.example.yml docker-compose.override.yml
#   # Edit docker-compose.override.yml
#   docker compose -f docker-compose.traefik.yml -f docker-compose.override.yml up -d
#
# Safety Notes:
#   - System routes (api, app) are defined in /etc/traefik/dynamic/system/
#   - Custom routes go in /etc/traefik/dynamic/custom/
#   - Malformed YAML in custom/ does NOT break system routes
#   - System routes cannot be overridden by custom configs (Traefik uses first match)
#   - Use unique router names to avoid conflicts

services:
  # =============================================================================
  # Example 1: Adding a service with localhost port publishing (whoami test)
  # =============================================================================
  #
  # Because Traefik uses host networking, it reaches services via localhost ports.
  # The service must publish its port to localhost, and the Traefik route must
  # point to http://${SERVICE_HOST}:<port>.
  #
  # Option A: Use Docker labels (Traefik Docker provider - simpler but limited)
  # Option B: Use file provider route in traefik-custom/ (more flexible)
  #
  # This example uses Docker labels. For file provider, see Example 3 below.
  #
  whoami:
    image: traefik/whoami:latest
    ports:
      # Publish to dual-stack localhost for Traefik to reach
      - "[::1]:8888:80"
      - "127.0.0.1:8888:80"
    labels:
      # Enable Traefik for this container
      - "traefik.enable=true"

      # Define the router
      - "traefik.http.routers.whoami.rule=Host(`whoami.${DOMAIN}`)"
      - "traefik.http.routers.whoami.entrypoints=websecure"
      - "traefik.http.routers.whoami.tls.certResolver=letsencrypt"

      # Apply security middlewares (reuse system middlewares)
      - "traefik.http.routers.whoami.middlewares=security-headers@file"

      # Point to the localhost port (NOT the container port)
      # SERVICE_HOST defaults to [::1] (see .env.example)
      - "traefik.http.services.whoami.loadbalancer.server.url=http://${SERVICE_HOST:-[::1]}:8888"

  # =============================================================================
  # Example 2: Adding Grafana with localhost port publishing
  # =============================================================================
  #
  # Real-world example: Adding a monitoring dashboard
  #
  # grafana:
  #   image: grafana/grafana:latest
  #   volumes:
  #     - grafana-data:/var/lib/grafana
  #   environment:
  #     - GF_SERVER_ROOT_URL=https://grafana.${DOMAIN}
  #     - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin}
  #   ports:
  #     - "[::1]:3002:3000"
  #     - "127.0.0.1:3002:3000"
  #   labels:
  #     - "traefik.enable=true"
  #     - "traefik.http.routers.grafana.rule=Host(`grafana.${DOMAIN}`)"
  #     - "traefik.http.routers.grafana.entrypoints=websecure"
  #     - "traefik.http.routers.grafana.tls.certResolver=letsencrypt"
  #     - "traefik.http.routers.grafana.middlewares=security-headers@file"
  #     - "traefik.http.services.grafana.loadbalancer.server.url=http://${SERVICE_HOST:-[::1]}:3002"

  # =============================================================================
  # Example 3: File provider route (for external or complex services)
  # =============================================================================
  #
  # For services not managed by Docker Compose, or when you want full control
  # over routing config, use the file provider instead of Docker labels.
  #
  # 1. Create traefik-custom/ directory in your project root
  # 2. Add YAML route files (see docker/traefik/examples/custom-route.example.yml)
  # 3. Mount it via the traefik volume override below
  #
  # Example: Route to an external Portainer instance at 192.168.1.50:9000
  #
  # Create traefik-custom/portainer.yml:
  #   http:
  #     routers:
  #       portainer:
  #         rule: "Host(`portainer.example.com`)"
  #         service: portainer-service
  #         entryPoints:
  #           - websecure
  #         middlewares:
  #           - security-headers
  #         tls:
  #           certResolver: letsencrypt
  #     services:
  #       portainer-service:
  #         loadBalancer:
  #           servers:
  #             - url: "http://192.168.1.50:9000"

  # =============================================================================
  # Traefik: Mount custom config directory (File Provider extension)
  # =============================================================================
  #
  # This extends the traefik service to mount a custom config directory.
  # Use this when you need routes to external services or complex configs.
  #
  traefik:
    volumes:
      # Mount custom config directory for file provider routes
      # Place your *.yml files in traefik-custom/ and they'll be auto-loaded
      - ./traefik-custom:/etc/traefik/dynamic/custom:ro

# Uncomment if using Grafana example:
# volumes:
#   grafana-data:
