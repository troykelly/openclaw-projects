# Docker Compose configuration for E2E testing
# Part of Epic #310, Issue #326, #958
#
# Usage:
#   docker compose -f docker-compose.test.yml up -d
#   pnpm run test:e2e
#   docker compose -f docker-compose.test.yml down -v
#
# IMPORTANT: When running from inside devcontainer via Docker-outside-of-Docker (DooD),
# bind mounts will NOT work as expected because sibling containers mount from the HOST
# filesystem, not the devcontainer filesystem. This compose file correctly uses build
# contexts (which copy files during image build) and does NOT use bind mounts. Do not
# add bind mounts to this file.
#
# SeaweedFS (S3 storage) is NOT required for E2E tests. The backend API starts successfully
# without S3 configuration - file storage features simply return null/unavailable when not
# configured. S3 config is validated at runtime (createS3StorageFromEnv returns null if
# S3_BUCKET, S3_REGION, S3_ACCESS_KEY, S3_SECRET_KEY env vars are missing).

services:
  postgres-test:
    build:
      context: .
      dockerfile: docker/postgres/Dockerfile
    container_name: openclaw-postgres-test
    environment:
      POSTGRES_USER: openclaw
      POSTGRES_PASSWORD: openclaw_test
      POSTGRES_DB: openclaw_test
    ports:
      - "[::1]:5433:5432"       # IPv6 (preferred)
      - "127.0.0.1:5433:5432"  # IPv4 fallback
    command:
      - postgres
      - -c
      - shared_preload_libraries=timescaledb,pg_cron
      - -c
      - cron.database_name=openclaw_test
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U openclaw -d openclaw_test"]
      interval: 5s
      timeout: 5s
      retries: 5

  migrate-test:
    build:
      context: .
      dockerfile: docker/migrate/Dockerfile
    container_name: openclaw-migrate-test
    command:
      - "-path=/migrations"
      - "-database=postgres://openclaw:openclaw_test@postgres-test:5432/openclaw_test?sslmode=disable"
      - "up"
    depends_on:
      postgres-test:
        condition: service_healthy

  backend-test:
    build:
      context: .
      dockerfile: docker/api/Dockerfile
    container_name: openclaw-backend-test
    environment:
      # Individual PG vars are required â€” createPool() in src/db.ts reads these
      # (DATABASE_URL is NOT parsed by the backend code)
      PGHOST: postgres-test
      PGPORT: "5432"
      PGUSER: openclaw
      PGPASSWORD: openclaw_test
      PGDATABASE: openclaw_test
      OPENCLAW_PROJECTS_AUTH_DISABLED: "true"
      NODE_ENV: test
      PORT: 3001
    ports:
      - "[::1]:3001:3001"       # IPv6 (preferred)
      - "127.0.0.1:3001:3001"  # IPv4 fallback
    depends_on:
      postgres-test:
        condition: service_healthy
      migrate-test:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3001/api/health || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 10

networks:
  default:
    name: openclaw-test-network
