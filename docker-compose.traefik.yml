# Production docker-compose with Traefik reverse proxy (Issue #529, #531)
#
# Features:
#   - Traefik 3.6 reverse proxy with automatic TLS via ACME DNS-01
#   - TLS 1.3 only with modern cipher suites
#   - HTTP/3 (QUIC) support on websecure entrypoint
#   - ModSecurity WAF with OWASP CRS for API traffic inspection
#   - Security headers and rate limiting
#   - Container hardening (read_only, no-new-privileges, cap_drop)
#
# Usage:
#   cp .env.example .env
#   # Edit .env and set required values:
#   #   - POSTGRES_PASSWORD, COOKIE_SECRET, S3_SECRET_KEY
#   #   - DOMAIN, ACME_EMAIL
#   #   - CF_DNS_API_TOKEN (or other DNS provider credentials)
#   docker compose -f docker-compose.traefik.yml up -d
#
# Required environment variables:
#   - DOMAIN: Your primary domain (e.g., example.com)
#   - ACME_EMAIL: Email for Let's Encrypt certificate notifications
#   - DNS provider credentials (e.g., CF_DNS_API_TOKEN for Cloudflare)
#
# See .env.example for full configuration options

name: openclaw-projects

services:
  # =============================================================================
  # Traefik Reverse Proxy
  # =============================================================================
  traefik:
    image: traefik:3.6
    container_name: openclaw-traefik
    restart: unless-stopped
    # Note: No depends_on - Traefik starts immediately and handles unhealthy backends
    # gracefully by returning 502/503 until services are ready. This is standard
    # reverse proxy behavior and allows faster startup. See docs/deployment.md
    # for details on startup behavior.
    environment:
      # Required for entrypoint script
      DOMAIN: ${DOMAIN:?DOMAIN is required}
      ACME_EMAIL: ${ACME_EMAIL:?ACME_EMAIL is required}
      TRUSTED_IPS: ${TRUSTED_IPS:-}
      DISABLE_HTTP: ${DISABLE_HTTP:-false}
      # DNS provider credentials (passed through to ACME)
      # Cloudflare
      CF_DNS_API_TOKEN: ${CF_DNS_API_TOKEN:-}
      CF_API_KEY: ${CF_API_KEY:-}
      CF_API_EMAIL: ${CF_API_EMAIL:-}
      # AWS Route53
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      AWS_HOSTED_ZONE_ID: ${AWS_HOSTED_ZONE_ID:-}
      AWS_REGION: ${AWS_REGION:-}
    command:
      # API and Dashboard
      - --api.dashboard=false
      - --api.insecure=false
      # Providers
      - --providers.docker=true
      - --providers.docker.exposedByDefault=false
      - --providers.docker.network=openclaw-projects_default
      - --providers.file.directory=/etc/traefik/dynamic
      - --providers.file.watch=true
      # Entrypoints
      - --entrypoints.web.address=:${HTTP_PORT:-80}
      - --entrypoints.web.http.redirections.entryPoint.to=websecure
      - --entrypoints.web.http.redirections.entryPoint.scheme=https
      - --entrypoints.web.http.redirections.entryPoint.permanent=true
      - --entrypoints.websecure.address=:${HTTPS_PORT:-443}
      - --entrypoints.websecure.http3=true
      - --entrypoints.websecure.http.tls=true
      - --entrypoints.websecure.http.tls.certResolver=letsencrypt
      - --entrypoints.websecure.http.tls.options=default@file
      # ACME Certificate Resolver (DNS-01 challenge)
      - --certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL:?ACME_EMAIL is required}
      - --certificatesresolvers.letsencrypt.acme.storage=/etc/traefik/acme/acme.json
      - --certificatesresolvers.letsencrypt.acme.dnschallenge=true
      - --certificatesresolvers.letsencrypt.acme.dnschallenge.provider=${ACME_DNS_PROVIDER:-cloudflare}
      - --certificatesresolvers.letsencrypt.acme.dnschallenge.delaybeforecheck=30
      - --certificatesresolvers.letsencrypt.acme.dnschallenge.disablepropagationcheck=true
      # Logging
      - --log.level=${TRAEFIK_LOG_LEVEL:-INFO}
      - --accesslog=true
      - --accesslog.format=json
    ports:
      # HTTP
      - "${HTTP_PORT:-80}:${HTTP_PORT:-80}"
      # HTTPS (TCP + UDP for HTTP/3)
      - "${HTTPS_PORT:-443}:${HTTPS_PORT:-443}/tcp"
      - "${HTTPS_PORT:-443}:${HTTPS_PORT:-443}/udp"
    volumes:
      # Docker socket for provider (read-only)
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Dynamic configuration template and output
      - ./docker/traefik/dynamic-config.yml.template:/etc/traefik/templates/dynamic-config.yml.template:ro
      - traefik_dynamic:/etc/traefik/dynamic
      # ACME certificate storage (host path for persistence across volume prunes)
      - /etc/traefik/acme:/etc/traefik/acme
    entrypoint: ["/entrypoint.sh"]
    healthcheck:
      test: ["CMD", "traefik", "healthcheck"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    # Container hardening
    read_only: true
    tmpfs:
      - /tmp:mode=1777,size=16M
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 512M
        reservations:
          cpus: "0.1"
          memory: 64M
    configs:
      - source: traefik_entrypoint
        target: /entrypoint.sh
        mode: 0755

  # =============================================================================
  # ModSecurity WAF (OWASP CRS)
  # =============================================================================
  # Web Application Firewall for API traffic inspection
  # Uses OWASP Core Rule Set for protection against common attacks
  # Static frontend assets bypass WAF (go directly to app)
  modsecurity:
    # Note: The image tag "apache-alpine" tracks CRS v4 (current latest).
    # The previous tag "4-apache-alpine" does not exist on Docker Hub.
    # For production stability, consider pinning to a specific version like:
    #   owasp/modsecurity-crs:4.23.0-apache-alpine-202602050102
    image: owasp/modsecurity-crs:apache-alpine
    container_name: openclaw-modsecurity
    restart: unless-stopped
    environment:
      # ModSecurity engine mode: On, Off, DetectionOnly
      MODSEC_RULE_ENGINE: ${MODSEC_ENABLED:-true}
      # OWASP CRS Paranoia Level (1-4)
      # 1 = Low false positives, basic protection
      # 2 = Moderate protection, some false positives
      # 3 = High security, more false positives
      # 4 = Maximum security, requires tuning
      PARANOIA: ${MODSEC_PARANOIA_LEVEL:-1}
      # Anomaly scoring thresholds
      ANOMALY_INBOUND: ${MODSEC_ANOMALY_INBOUND:-5}
      ANOMALY_OUTBOUND: ${MODSEC_ANOMALY_OUTBOUND:-4}
      # Backend proxy target (required for forwardAuth validation)
      BACKEND: http://api:3001
      # Upstream connection timeout
      PROXY_TIMEOUT: 60
      # Enable request body access for inspection
      MODSEC_REQ_BODY_ACCESS: "On"
      MODSEC_REQ_BODY_LIMIT: 13107200
      MODSEC_REQ_BODY_NOFILES_LIMIT: 131072
      # Enable response body access for inspection
      MODSEC_RESP_BODY_ACCESS: "On"
      MODSEC_RESP_BODY_LIMIT: 1048576
      # Audit logging (minimal in production)
      MODSEC_AUDIT_LOG: "/dev/stdout"
      MODSEC_AUDIT_LOG_FORMAT: JSON
      MODSEC_AUDIT_LOG_TYPE: Serial
      MODSEC_AUDIT_ENGINE: RelevantOnly
      # Error log to stdout for container logging
      ERRORLOG: "/dev/stderr"
      # Port to listen on (8080 required - container runs unprivileged)
      PORT: 8080
      # Server name
      SERVER_NAME: modsecurity
    expose:
      - "8080"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:8080/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    # Container hardening
    read_only: true
    tmpfs:
      - /tmp:mode=1777,size=64M
      - /var/log/apache2:mode=1777,size=32M
      - /var/run/apache2:mode=1777,size=8M
      - /var/lock/apache2:mode=1777,size=8M
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 512M
        reservations:
          cpus: "0.1"
          memory: 128M
    labels:
      # Enable Traefik for ModSecurity service
      - "traefik.enable=true"
      # Service configuration (used by dynamic config)
      - "traefik.http.services.modsecurity.loadbalancer.server.port=8080"
      - "traefik.http.services.modsecurity.loadbalancer.healthcheck.path=/healthz"
      - "traefik.http.services.modsecurity.loadbalancer.healthcheck.interval=10s"

  # =============================================================================
  # Database (PostgreSQL with TimescaleDB, pgvector, pg_cron)
  # =============================================================================
  db:
    image: ghcr.io/troykelly/openclaw-projects-db:latest
    container_name: openclaw-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-openclaw}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      POSTGRES_DB: ${POSTGRES_DB:-openclaw}
    command:
      - postgres
      - -c
      - shared_preload_libraries=timescaledb,pg_cron
      - -c
      - cron.database_name=${POSTGRES_DB:-openclaw}
    # Note: PostgreSQL 18+ uses versioned subdirectories (e.g., /18/docker)
    # Mount at /var/lib/postgresql to allow proper version management
    volumes:
      - db_data:/var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER:-openclaw} -d $${POSTGRES_DB:-openclaw}"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    # PostgreSQL requires more shared memory than Docker's default 64MB
    shm_size: 256mb
    # Container hardening
    # Note: PostgreSQL requires more capabilities than other services for initialization
    # We keep no-new-privileges but don't drop all capabilities
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M

  # =============================================================================
  # SeaweedFS (S3-compatible object storage)
  # =============================================================================
  seaweedfs:
    image: chrislusf/seaweedfs:4.09
    container_name: openclaw-seaweedfs
    restart: unless-stopped
    entrypoint: ["/docker-entrypoint-s3.sh"]
    environment:
      # S3 authentication credentials (must match API configuration)
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-openclaw}
      S3_SECRET_KEY: ${S3_SECRET_KEY:?S3_SECRET_KEY is required}
      # Volume configuration (production defaults)
      SEAWEEDFS_VOLUME_SIZE_LIMIT_MB: ${SEAWEEDFS_VOLUME_SIZE_LIMIT_MB:-30000}
      SEAWEEDFS_VOLUME_MAX: ${SEAWEEDFS_VOLUME_MAX:-100}
    volumes:
      - seaweedfs_data:/data
      - ./docker/seaweedfs/s3.json.template:/etc/seaweedfs/s3.json.template:ro
      - ./docker/seaweedfs/entrypoint.sh:/docker-entrypoint-s3.sh:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://127.0.0.1:9333/cluster/status"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 30s
    # Container hardening
    # Note: SeaweedFS entrypoint needs CHOWN for /data ownership and
    # SETGID/SETUID for su-exec user switching
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 256M

  # =============================================================================
  # Database Migrations (runs once and exits)
  # =============================================================================
  migrate:
    image: ghcr.io/troykelly/openclaw-projects-migrate:latest
    container_name: openclaw-migrate
    restart: "no"
    depends_on:
      db:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-openclaw}:${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}@db:5432/${POSTGRES_DB:-openclaw}?sslmode=disable
    command:
      - -path
      - /migrations
      - -database
      - postgresql://${POSTGRES_USER:-openclaw}:${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}@db:5432/${POSTGRES_DB:-openclaw}?sslmode=disable
      - up
    # Container hardening
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

  # =============================================================================
  # API Server (Fastify)
  # =============================================================================
  api:
    image: ghcr.io/troykelly/openclaw-projects-api:latest
    container_name: openclaw-api
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      seaweedfs:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    environment:
      NODE_ENV: production
      HOST: 0.0.0.0
      # Port 3001 (not 3000) to avoid conflicts with Traefik service labels.
      # ModSecurity and nginx proxy both use this port.
      PORT: 3001
      PUBLIC_BASE_URL: https://api.${DOMAIN:?DOMAIN is required}
      COOKIE_SECRET: ${COOKIE_SECRET:?COOKIE_SECRET is required}
      # Database connection
      PGHOST: db
      PGPORT: 5432
      PGUSER: ${POSTGRES_USER:-openclaw}
      PGPASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      PGDATABASE: ${POSTGRES_DB:-openclaw}
      # S3-compatible storage (SeaweedFS)
      S3_ENDPOINT: http://seaweedfs:8333
      S3_BUCKET: ${S3_BUCKET:-openclaw}
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-openclaw}
      S3_SECRET_KEY: ${S3_SECRET_KEY:?S3_SECRET_KEY is required}
      S3_FORCE_PATH_STYLE: "true"
      # Optional: Postmark email (magic links)
      POSTMARK_FROM: ${POSTMARK_FROM:-}
      POSTMARK_REPLY_TO: ${POSTMARK_REPLY_TO:-}
      POSTMARK_MESSAGE_STREAM: ${POSTMARK_MESSAGE_STREAM:-outbound}
      POSTMARK_TRANSACTIONAL_TOKEN: ${POSTMARK_TRANSACTIONAL_TOKEN:-}
      # Authentication for OpenClaw plugin requests
      # At least one of: OPENCLAW_PROJECTS_AUTH_SECRET, _FILE, or _COMMAND must be set
      # OR set OPENCLAW_PROJECTS_AUTH_DISABLED=true (not recommended for production)
      OPENCLAW_PROJECTS_AUTH_SECRET: ${OPENCLAW_PROJECTS_AUTH_SECRET:-}
      OPENCLAW_PROJECTS_AUTH_SECRET_FILE: ${OPENCLAW_PROJECTS_AUTH_SECRET_FILE:-}
      OPENCLAW_PROJECTS_AUTH_SECRET_COMMAND: ${OPENCLAW_PROJECTS_AUTH_SECRET_COMMAND:-}
      OPENCLAW_PROJECTS_AUTH_DISABLED: ${OPENCLAW_PROJECTS_AUTH_DISABLED:-false}
      # Embedding provider
      EMBEDDING_PROVIDER: ${EMBEDDING_PROVIDER:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENAI_API_KEY_FILE: ${OPENAI_API_KEY_FILE:-}
      OPENAI_API_KEY_COMMAND: ${OPENAI_API_KEY_COMMAND:-}
      VOYAGERAI_API_KEY: ${VOYAGERAI_API_KEY:-}
      VOYAGERAI_API_KEY_FILE: ${VOYAGERAI_API_KEY_FILE:-}
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      GEMINI_API_KEY_FILE: ${GEMINI_API_KEY_FILE:-}
      # SMS (Twilio) - optional
      TWILIO_ACCOUNT_SID: ${TWILIO_ACCOUNT_SID:-}
      TWILIO_AUTH_TOKEN: ${TWILIO_AUTH_TOKEN:-}
      TWILIO_FROM_NUMBER: ${TWILIO_FROM_NUMBER:-}
      # Rate limiting
      RATE_LIMIT_MAX: ${RATE_LIMIT_MAX:-100}
      RATE_LIMIT_WINDOW_MS: ${RATE_LIMIT_WINDOW_MS:-60000}
      # Webhook security
      WEBHOOK_IP_WHITELIST_DISABLED: ${WEBHOOK_IP_WHITELIST_DISABLED:-false}
      # OpenClaw integration
      OPENCLAW_GATEWAY_URL: ${OPENCLAW_GATEWAY_URL:-}
      OPENCLAW_HOOK_TOKEN: ${OPENCLAW_HOOK_TOKEN:-}
      # File upload
      MAX_FILE_SIZE_BYTES: ${MAX_FILE_SIZE_BYTES:-10485760}
    expose:
      - "3001"
    healthcheck:
      test: ["CMD-SHELL", "node -e \"fetch('http://127.0.0.1:3001/health').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))\""]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 15s
    # Container hardening
    read_only: true
    tmpfs:
      - /tmp:mode=1777,size=64M
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 256M
    labels:
      # API service is accessed via ModSecurity WAF, not directly via Traefik
      # The dynamic config routes api.DOMAIN -> modsecurity -> api
      - "traefik.enable=false"

  # =============================================================================
  # Frontend App (React SPA served via static server)
  # =============================================================================
  app:
    image: ghcr.io/troykelly/openclaw-projects-app:latest
    container_name: openclaw-app
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    environment:
      # API proxy configuration for nginx
      # Nginx proxies /api/* requests to the API container
      # Note: In Traefik mode, API runs on port 3001
      API_HOST: api
      API_PORT: "3001"
    expose:
      - "8080"
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O /dev/null http://127.0.0.1:8080/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s
    # Container hardening
    read_only: true
    tmpfs:
      - /tmp:mode=1777,size=32M
      - /var/cache/nginx:mode=1777,size=32M
      - /var/run:mode=1777,size=8M
      # Nginx entrypoint writes processed templates here
      - /etc/nginx/conf.d:mode=1777,size=1M
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 64M
    labels:
      # Enable Traefik for this service
      - "traefik.enable=true"
      # Router for App (main domain and www)
      - "traefik.http.routers.app.rule=Host(`${DOMAIN:?DOMAIN is required}`) || Host(`www.${DOMAIN:?DOMAIN is required}`)"
      - "traefik.http.routers.app.entrypoints=websecure"
      - "traefik.http.routers.app.tls=true"
      - "traefik.http.routers.app.tls.certResolver=letsencrypt"
      - "traefik.http.routers.app.tls.options=default@file"
      - "traefik.http.routers.app.middlewares=security-headers@file,compress@file"
      # Service configuration (nginx listens on 8080)
      - "traefik.http.services.app.loadbalancer.server.port=8080"
      - "traefik.http.services.app.loadbalancer.healthcheck.path=/"
      - "traefik.http.services.app.loadbalancer.healthcheck.interval=10s"

volumes:
  db_data:
  seaweedfs_data:
  traefik_dynamic:

configs:
  traefik_entrypoint:
    file: ./docker/traefik/entrypoint.sh
