# Full-fat docker-compose with OpenClaw gateway (Issue #583)
#
# Extends the Traefik configuration to include the OpenClaw gateway.
# This provides a complete self-hosted deployment with:
#   - All services from docker-compose.traefik.yml
#   - OpenClaw gateway with dashboard, websocket, and webhook endpoints
#
# Architecture:
#   Internet
#      |
#      v
#   Traefik (host network, :80/:443)
#      |
#      +-- DOMAIN/          --> [::1]:APP_HOST_PORT   (app frontend)
#      +-- api.DOMAIN/      --> [::1]:MODSEC_HOST_PORT (modsecurity --> api)
#      +-- s3.DOMAIN/       --> [::1]:SEAWEEDFS_HOST_PORT (seaweedfs S3)
#      +-- DOMAIN/openclaw/ --> [::1]:GATEWAY_HOST_PORT (openclaw-gateway)
#      +-- ws.DOMAIN/       --> [::1]:GATEWAY_HOST_PORT (openclaw-gateway)
#      +-- hooks.DOMAIN/    --> [::1]:GATEWAY_HOST_PORT (openclaw-gateway)
#
# Usage:
#   cp .env.example .env
#   # Edit .env and set:
#   #   - Core settings (POSTGRES_PASSWORD, COOKIE_SECRET, S3_SECRET_KEY)
#   #   - Domain settings (DOMAIN, ACME_EMAIL, CF_DNS_API_TOKEN)
#   #   - OpenClaw settings (OPENCLAW_GATEWAY_TOKEN, model provider keys)
#   docker compose -f docker-compose.full.yml up -d
#
# Required environment variables (in addition to docker-compose.traefik.yml):
#   - OPENCLAW_GATEWAY_TOKEN: Token for authenticating with OpenClaw gateway
#   - Model provider credentials (at least one): OPENAI_API_KEY, ANTHROPIC_API_KEY, etc.
#
# See .env.example for full configuration options

name: openclaw-projects

services:
  # =============================================================================
  # Include all services from Traefik compose
  # =============================================================================
  # Note: This file uses YAML anchors and extends where possible, but Docker
  # Compose doesn't support true inheritance. Services are duplicated with
  # modifications for the OpenClaw gateway integration.

  # =============================================================================
  # Traefik Reverse Proxy (extended for OpenClaw routes)
  # =============================================================================
  traefik:
    image: traefik:3.6
    container_name: openclaw-traefik
    restart: unless-stopped
    # Host networking: Traefik binds directly to host ports and sees real client IPs.
    # Without this, Traefik would only see Docker bridge gateway IPs, breaking
    # rate limiting, access logs, and IP-based security rules.
    network_mode: host
    environment:
      DOMAIN: ${DOMAIN:?DOMAIN is required}
      ACME_EMAIL: ${ACME_EMAIL:?ACME_EMAIL is required}
      TRUSTED_IPS: ${TRUSTED_IPS:-}
      DISABLE_HTTP: ${DISABLE_HTTP:-false}
      # Host networking: address and ports Traefik uses to reach backend services
      # Services publish their ports to localhost; Traefik connects via these settings.
      # Set SERVICE_HOST to 127.0.0.1 for IPv4-only environments.
      SERVICE_HOST: ${SERVICE_HOST:-[::1]}
      MODSEC_HOST_PORT: ${MODSEC_HOST_PORT:-8080}
      API_HOST_PORT: ${API_HOST_PORT:-3001}
      APP_HOST_PORT: ${APP_HOST_PORT:-8081}
      GATEWAY_HOST_PORT: ${GATEWAY_HOST_PORT:-18789}
      SEAWEEDFS_HOST_PORT: ${SEAWEEDFS_HOST_PORT:-8333}
      # DNS provider credentials (passed through to ACME/lego)
      # Note: lego checks CF_DNS_API_TOKEN first — if set (even empty),
      # it ignores CF_API_KEY + CF_API_EMAIL.  The entrypoint unsets
      # empty values to prevent this.  Only set the vars you use.
      # Cloudflare — scoped API token (preferred)
      CF_DNS_API_TOKEN: ${CF_DNS_API_TOKEN:-}
      # Cloudflare — Global API Key (legacy fallback)
      CF_API_KEY: ${CF_API_KEY:-}
      CF_API_EMAIL: ${CF_API_EMAIL:-}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      AWS_HOSTED_ZONE_ID: ${AWS_HOSTED_ZONE_ID:-}
      AWS_REGION: ${AWS_REGION:-}
    command:
      - --api.dashboard=false
      - --api.insecure=false
      # Ping endpoint for healthchecks (bound to dedicated entrypoint to avoid
      # conflicting with ModSecurity on the default port 8080)
      - --ping=true
      - --ping.entryPoint=ping
      - --providers.docker=true
      - --providers.docker.exposedByDefault=false
      # Note: --providers.docker.network is omitted because Traefik uses host networking
      # and cannot resolve Docker container IPs. All routing is via file provider.
      - --providers.file.directory=/etc/traefik/dynamic
      - --providers.file.watch=true
      # Entrypoints (Traefik binds directly to host ports via network_mode: host)
      - --entrypoints.ping.address=:8082
      - --entrypoints.web.address=:${HTTP_PORT:-80}
      - --entrypoints.web.http.redirections.entryPoint.to=websecure
      - --entrypoints.web.http.redirections.entryPoint.scheme=https
      - --entrypoints.web.http.redirections.entryPoint.permanent=true
      - --entrypoints.websecure.address=:${HTTPS_PORT:-443}
      - --entrypoints.websecure.http3=true
      - --entrypoints.websecure.http.tls=true
      - --entrypoints.websecure.http.tls.certResolver=letsencrypt
      - --entrypoints.websecure.http.tls.options=default@file
      - --certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL:?ACME_EMAIL is required}
      - --certificatesresolvers.letsencrypt.acme.storage=/etc/traefik/acme/acme.json
      - --certificatesresolvers.letsencrypt.acme.dnschallenge=true
      - --certificatesresolvers.letsencrypt.acme.dnschallenge.provider=${ACME_DNS_PROVIDER:-cloudflare}
      - --certificatesresolvers.letsencrypt.acme.dnschallenge.delaybeforecheck=30
      - --certificatesresolvers.letsencrypt.acme.dnschallenge.disablepropagationcheck=true
      - --log.level=${TRAEFIK_LOG_LEVEL:-INFO}
      - --accesslog=true
      - --accesslog.format=json
    # Note: No ports section - network_mode: host binds directly to host ports
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./docker/traefik/dynamic-config.yml.template:/etc/traefik/templates/dynamic-config.yml.template:ro
      - traefik_dynamic:/etc/traefik/dynamic
      # ACME certificate storage (host path for persistence across volume prunes)
      - /etc/traefik/acme:/etc/traefik/acme
    entrypoint: ["/entrypoint.sh"]
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:8082/ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    read_only: true
    tmpfs:
      - /tmp:mode=1777,size=16M
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
      # CHOWN + FOWNER: required for ACME storage initialisation.
      # The host bind-mount (/etc/traefik/acme) is created as root, but Traefik
      # 3.x runs as non-root (UID 65532). The entrypoint needs to chown/chmod
      # acme.json so Traefik can read/write certificates.
      - CHOWN
      - FOWNER
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 512M
        reservations:
          cpus: "0.1"
          memory: 64M
    configs:
      - source: traefik_entrypoint
        target: /entrypoint.sh
        mode: 0755

  # =============================================================================
  # ModSecurity WAF (unchanged from Traefik compose)
  # =============================================================================
  modsecurity:
    image: owasp/modsecurity-crs:apache-alpine
    container_name: openclaw-modsecurity
    restart: unless-stopped
    environment:
      MODSEC_RULE_ENGINE: ${MODSEC_RULE_ENGINE:-On}
      # Pass backend error responses through as-is (don't replace with Apache HTML)
      PROXY_ERROR_OVERRIDE: "Off"
      PARANOIA: ${MODSEC_PARANOIA_LEVEL:-1}
      ANOMALY_INBOUND: ${MODSEC_ANOMALY_INBOUND:-5}
      ANOMALY_OUTBOUND: ${MODSEC_ANOMALY_OUTBOUND:-4}
      BACKEND: http://api:3001
      PROXY_TIMEOUT: 60
      MODSEC_REQ_BODY_ACCESS: "On"
      MODSEC_REQ_BODY_LIMIT: 13107200
      MODSEC_REQ_BODY_NOFILES_LIMIT: 131072
      MODSEC_RESP_BODY_ACCESS: "On"
      MODSEC_RESP_BODY_LIMIT: 1048576
      MODSEC_AUDIT_LOG: "/dev/stdout"
      MODSEC_AUDIT_LOG_FORMAT: JSON
      MODSEC_AUDIT_LOG_TYPE: Serial
      MODSEC_AUDIT_ENGINE: RelevantOnly
      ERRORLOG: "/dev/stderr"
      PORT: 8080
      SERVER_NAME: modsecurity
    # Publish to localhost for Traefik (host networking mode)
    ports:
      - "[::1]:${MODSEC_HOST_PORT:-8080}:8080"       # IPv6 (preferred)
      - "127.0.0.1:${MODSEC_HOST_PORT:-8080}:8080"  # IPv4 fallback
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:8080/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    read_only: true
    volumes:
      # Named volumes for directories the CRS entrypoint must read AND write.
      # Unlike tmpfs, named volumes auto-populate from the image content on first
      # creation, so files like setup.conf and the bundled CRS rules are preserved.
      # The entrypoint's activate-plugins.sh runs sed against setup.conf and
      # configure-rules.sh edits crs-setup.conf — both fail on an empty tmpfs.
      # See: https://github.com/coreruleset/modsecurity-crs-docker
      - modsec_conf:/etc/modsecurity.d
      # CRS rules dir — /etc/modsecurity.d/owasp-crs symlinks here; configure-rules.sh
      # uses ed to modify crs-setup.conf which fails on a read-only root filesystem
      - modsec_crs:/opt/owasp-crs
      # Apache conf dir — entrypoint generates a self-signed TLS certificate here
      - modsec_apache_conf:/usr/local/apache2/conf
    tmpfs:
      - /tmp:mode=1777,size=64M
      - /var/log/apache2:mode=1777,size=32M
      - /var/run/apache2:mode=1777,size=8M
      - /var/lock/apache2:mode=1777,size=8M
      # Apache writes httpd.pid here at startup
      - /usr/local/apache2/logs:mode=1777,size=1M
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 512M
        reservations:
          cpus: "0.1"
          memory: 128M
    # Note: No Traefik labels - routing is handled by the file provider
    # (dynamic-config.yml.template) which routes api.DOMAIN -> modsecurity -> api

  # =============================================================================
  # Database (unchanged from Traefik compose)
  # =============================================================================
  db:
    image: ghcr.io/troykelly/openclaw-projects-db:latest
    container_name: openclaw-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-openclaw}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      POSTGRES_DB: ${POSTGRES_DB:-openclaw}
    command:
      - postgres
      - -c
      - shared_preload_libraries=timescaledb,pg_cron
      - -c
      - cron.database_name=${POSTGRES_DB:-openclaw}
    volumes:
      - db_data:/var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER:-openclaw} -d $${POSTGRES_DB:-openclaw}"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    shm_size: 256mb
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M

  # =============================================================================
  # SeaweedFS (unchanged from Traefik compose)
  # =============================================================================
  seaweedfs:
    image: chrislusf/seaweedfs:4.09
    container_name: openclaw-seaweedfs
    restart: unless-stopped
    entrypoint: ["/docker-entrypoint-s3.sh"]
    environment:
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-openclaw}
      S3_SECRET_KEY: ${S3_SECRET_KEY:?S3_SECRET_KEY is required}
      SEAWEEDFS_VOLUME_SIZE_LIMIT_MB: ${SEAWEEDFS_VOLUME_SIZE_LIMIT_MB:-30000}
      SEAWEEDFS_VOLUME_MAX: ${SEAWEEDFS_VOLUME_MAX:-100}
    # Publish S3 port to localhost for Traefik (host networking mode)
    # Enables presigned URL access via s3.DOMAIN Traefik route
    ports:
      - "[::1]:${SEAWEEDFS_HOST_PORT:-8333}:8333"       # IPv6 (preferred)
      - "127.0.0.1:${SEAWEEDFS_HOST_PORT:-8333}:8333"  # IPv4 fallback
    volumes:
      - seaweedfs_data:/data
      - ./docker/seaweedfs/s3.json.template:/etc/seaweedfs/s3.json.template:ro
      - ./docker/seaweedfs/entrypoint.sh:/docker-entrypoint-s3.sh:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://127.0.0.1:9333/cluster/status"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 30s
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 256M

  # =============================================================================
  # Database Migrations (unchanged from Traefik compose)
  # =============================================================================
  migrate:
    image: ghcr.io/troykelly/openclaw-projects-migrate:latest
    container_name: openclaw-migrate
    restart: "no"
    depends_on:
      db:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-openclaw}:${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}@db:5432/${POSTGRES_DB:-openclaw}?sslmode=disable
    command:
      - -path
      - /migrations
      - -database
      - postgresql://${POSTGRES_USER:-openclaw}:${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}@db:5432/${POSTGRES_DB:-openclaw}?sslmode=disable
      - up
    read_only: true
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

  # =============================================================================
  # API Server (unchanged from Traefik compose)
  # =============================================================================
  api:
    image: ghcr.io/troykelly/openclaw-projects-api:latest
    container_name: openclaw-api
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      seaweedfs:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    environment:
      NODE_ENV: production
      HOST: "::"
      PORT: 3001
      # PUBLIC_BASE_URL is the app/root domain where the SPA is served, NOT the
      # API subdomain. The API URL is derived automatically as api.${DOMAIN} by
      # deriveApiUrl() in server.ts. Changed from https://api.${DOMAIN} in
      # v0.0.56 (#1328). See docs/deployment.md "Breaking Changes".
      PUBLIC_BASE_URL: https://${DOMAIN:?DOMAIN is required}
      COOKIE_SECRET: ${COOKIE_SECRET:?COOKIE_SECRET is required}
      # JWT signing (required for production auth)
      JWT_SECRET: ${JWT_SECRET:-}
      JWT_SECRET_PREVIOUS: ${JWT_SECRET_PREVIOUS:-}
      PGHOST: db
      PGPORT: 5432
      PGUSER: ${POSTGRES_USER:-openclaw}
      PGPASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      PGDATABASE: ${POSTGRES_DB:-openclaw}
      S3_ENDPOINT: http://seaweedfs:8333
      S3_BUCKET: ${S3_BUCKET:-openclaw}
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-openclaw}
      S3_SECRET_KEY: ${S3_SECRET_KEY:?S3_SECRET_KEY is required}
      S3_FORCE_PATH_STYLE: "true"
      # External S3 endpoint for presigned URL rewriting
      # When set, presigned URLs use this public address instead of the internal
      # Docker endpoint. Requires s3.DOMAIN DNS + Traefik route (automatic).
      S3_EXTERNAL_ENDPOINT: ${S3_EXTERNAL_ENDPOINT:-https://s3.${DOMAIN}}
      POSTMARK_FROM_EMAIL: ${POSTMARK_FROM_EMAIL:-${POSTMARK_FROM:-}}
      POSTMARK_REPLY_TO: ${POSTMARK_REPLY_TO:-}
      POSTMARK_MESSAGE_STREAM: ${POSTMARK_MESSAGE_STREAM:-outbound}
      POSTMARK_TRANSACTIONAL_TOKEN: ${POSTMARK_TRANSACTIONAL_TOKEN:-}
      OPENCLAW_API_TOKEN: ${OPENCLAW_API_TOKEN:-}
      OPENCLAW_PROJECTS_AUTH_DISABLED: ${OPENCLAW_PROJECTS_AUTH_DISABLED:-false}
      EMBEDDING_PROVIDER: ${EMBEDDING_PROVIDER:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENAI_API_KEY_FILE: ${OPENAI_API_KEY_FILE:-}
      OPENAI_API_KEY_COMMAND: ${OPENAI_API_KEY_COMMAND:-}
      VOYAGERAI_API_KEY: ${VOYAGERAI_API_KEY:-}
      VOYAGERAI_API_KEY_FILE: ${VOYAGERAI_API_KEY_FILE:-}
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      GEMINI_API_KEY_FILE: ${GEMINI_API_KEY_FILE:-}
      # OAuth integration (Microsoft 365 / Google)
      # Required for contacts, email, drive/files, calendar features
      # See docs/guides/oauth-setup.md for credential setup
      # Set OAUTH_REDIRECT_URI=https://api.${DOMAIN}/api/oauth/callback
      MS365_CLIENT_ID: ${MS365_CLIENT_ID:-}
      MS365_CLIENT_SECRET: ${MS365_CLIENT_SECRET:-}
      AZURE_TENANT_ID: ${AZURE_TENANT_ID:-}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      OAUTH_REDIRECT_URI: ${OAUTH_REDIRECT_URI:-}
      OAUTH_TOKEN_ENCRYPTION_KEY: ${OAUTH_TOKEN_ENCRYPTION_KEY:-}
      TWILIO_ACCOUNT_SID: ${TWILIO_ACCOUNT_SID:-}
      TWILIO_AUTH_TOKEN: ${TWILIO_AUTH_TOKEN:-}
      TWILIO_FROM_NUMBER: ${TWILIO_FROM_NUMBER:-}
      # Inbound webhook authentication
      POSTMARK_WEBHOOK_USERNAME: ${POSTMARK_WEBHOOK_USERNAME:-}
      POSTMARK_WEBHOOK_PASSWORD: ${POSTMARK_WEBHOOK_PASSWORD:-}
      CLOUDFLARE_EMAIL_SECRET: ${CLOUDFLARE_EMAIL_SECRET:-}
      RATE_LIMIT_MAX: ${RATE_LIMIT_MAX:-100}
      RATE_LIMIT_WINDOW_MS: ${RATE_LIMIT_WINDOW_MS:-60000}
      WEBHOOK_IP_WHITELIST_DISABLED: ${WEBHOOK_IP_WHITELIST_DISABLED:-false}
      OPENCLAW_GATEWAY_URL: http://openclaw-gateway:18789
      # Nominatim (reverse geocoding for geo-contextual search)
      NOMINATIM_URL: ${NOMINATIM_URL:-http://nominatim:8080}
      MAX_FILE_SIZE_BYTES: ${MAX_FILE_SIZE_BYTES:-10485760}
    # Publish to localhost for Traefik (host networking mode)
    ports:
      - "[::1]:${API_HOST_PORT:-3001}:3001"       # IPv6 (preferred)
      - "127.0.0.1:${API_HOST_PORT:-3001}:3001"  # IPv4 fallback
    healthcheck:
      test: ["CMD-SHELL", "node -e \"fetch('http://127.0.0.1:3001/health').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))\""]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 15s
    read_only: true
    tmpfs:
      - /tmp:mode=1777,size=64M
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 256M
    labels:
      - "traefik.enable=false"

  # =============================================================================
  # Background Worker (job processing, notifications, embeddings)
  # =============================================================================
  worker:
    image: ghcr.io/troykelly/openclaw-projects-worker:latest
    container_name: openclaw-worker
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    environment:
      NODE_ENV: production
      PGHOST: db
      PGPORT: 5432
      PGUSER: ${POSTGRES_USER:-openclaw}
      PGPASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      PGDATABASE: ${POSTGRES_DB:-openclaw}
      OPENCLAW_GATEWAY_URL: http://openclaw-gateway:18789
      OPENCLAW_HOOK_TOKEN: ${OPENCLAW_HOOK_TOKEN:-}   # Gateway hooks auth (separate from API M2M token)
      OPENCLAW_API_TOKEN: ${OPENCLAW_API_TOKEN:-}
      # JWT signing (required when worker verifies tokens)
      JWT_SECRET: ${JWT_SECRET:-}
      JWT_SECRET_PREVIOUS: ${JWT_SECRET_PREVIOUS:-}
      EMBEDDING_PROVIDER: ${EMBEDDING_PROVIDER:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENAI_API_KEY_FILE: ${OPENAI_API_KEY_FILE:-}
      OPENAI_API_KEY_COMMAND: ${OPENAI_API_KEY_COMMAND:-}
      VOYAGERAI_API_KEY: ${VOYAGERAI_API_KEY:-}
      VOYAGERAI_API_KEY_FILE: ${VOYAGERAI_API_KEY_FILE:-}
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      GEMINI_API_KEY_FILE: ${GEMINI_API_KEY_FILE:-}
      TWILIO_ACCOUNT_SID: ${TWILIO_ACCOUNT_SID:-}
      TWILIO_AUTH_TOKEN: ${TWILIO_AUTH_TOKEN:-}
      TWILIO_FROM_NUMBER: ${TWILIO_FROM_NUMBER:-}
      POSTMARK_FROM_EMAIL: ${POSTMARK_FROM_EMAIL:-${POSTMARK_FROM:-}}
      POSTMARK_REPLY_TO: ${POSTMARK_REPLY_TO:-}
      POSTMARK_MESSAGE_STREAM: ${POSTMARK_MESSAGE_STREAM:-outbound}
      POSTMARK_TRANSACTIONAL_TOKEN: ${POSTMARK_TRANSACTIONAL_TOKEN:-}
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:9000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    # Container hardening
    read_only: true
    tmpfs:
      - /tmp:mode=1777,size=64M
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 128M

  # =============================================================================
  # Frontend App (unchanged from Traefik compose)
  # =============================================================================
  app:
    image: ghcr.io/troykelly/openclaw-projects-app:latest
    container_name: openclaw-app
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    environment:
      API_HOST: api
      API_PORT: "3001"
    # Publish to localhost for Traefik (host networking mode)
    # Default host port 8081 avoids conflict with ModSecurity on 8080
    ports:
      - "[::1]:${APP_HOST_PORT:-8081}:8080"       # IPv6 (preferred)
      - "127.0.0.1:${APP_HOST_PORT:-8081}:8080"  # IPv4 fallback
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O /dev/null http://127.0.0.1:8080/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s
    read_only: true
    tmpfs:
      - /tmp:mode=1777,size=32M
      - /var/cache/nginx:mode=1777,size=32M
      - /var/run:mode=1777,size=8M
      - /etc/nginx/conf.d:mode=1777,size=1M
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 64M
    # Note: No Traefik labels - routing is handled by the file provider
    # (dynamic-config.yml.template) which routes DOMAIN/www.DOMAIN -> app

  # =============================================================================
  # Nominatim (Reverse Geocoding)
  # =============================================================================
  # Self-hosted OpenStreetMap geocoder for geo-contextual search features.
  # On first start, imports the PBF extract (this takes 10+ minutes depending
  # on region size). After import, the service provides fast local geocoding.
  # If Nominatim is unavailable, geo features silently degrade.
  nominatim:
    image: mediagis/nominatim:4.4
    profiles: ["geo"]
    container_name: openclaw-nominatim
    restart: unless-stopped
    environment:
      # OpenStreetMap PBF extract to import
      # Find regional extracts at: https://download.geofabrik.de/
      PBF_URL: ${NOMINATIM_PBF_URL:-https://download.geofabrik.de/australia-oceania/australia-latest.osm.pbf}
      REPLICATION_URL: ${NOMINATIM_REPLICATION_URL:-https://download.geofabrik.de/australia-oceania/australia-updates/}
      NOMINATIM_PASSWORD: ${NOMINATIM_PASSWORD:-openclaw}
    volumes:
      - nominatim_data:/var/lib/postgresql/14/main
    # Publish to localhost for potential external access
    ports:
      - "[::1]:${NOMINATIM_HOST_PORT:-8180}:8080"       # IPv6 (preferred)
      - "127.0.0.1:${NOMINATIM_HOST_PORT:-8180}:8080"  # IPv4 fallback
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/status"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 600s
    # Container hardening
    # Note: Nominatim runs PostgreSQL internally and requires more capabilities
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 4G
        reservations:
          cpus: "0.5"
          memory: 1G

  # =============================================================================
  # OpenClaw Gateway (AI Agent Gateway)
  # =============================================================================
  # The OpenClaw gateway manages AI agent sessions, routes messages from
  # connected channels (WhatsApp, Telegram, Discord, etc.), executes tools,
  # and maintains persistent memory.
  #
  # Endpoints exposed via Traefik (defined in dynamic-config.yml.template):
  #   - https://DOMAIN/openclaw/        -> Dashboard/debug UI
  #   - wss://ws.DOMAIN/                -> WebSocket for agent connections
  #   - https://hooks.DOMAIN/           -> Webhook receiver for channels
  #
  # The openclaw-projects plugin is automatically configured to connect to
  # the API server using the shared OPENCLAW_API_TOKEN (long-lived JWT).
  openclaw-gateway:
    # Use the pre-built OpenClaw image. Alternative: build locally with openclaw:local
    # See https://docs.openclaw.ai/install/docker for build instructions
    image: ${OPENCLAW_IMAGE:-ghcr.io/phioranex/openclaw-docker:latest}
    container_name: openclaw-gateway
    restart: unless-stopped
    depends_on:
      api:
        condition: service_healthy
    environment:
      # Gateway configuration
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN:?OPENCLAW_GATEWAY_TOKEN is required}
      OPENCLAW_BIND: "::"
      OPENCLAW_HOME: /home/node/.openclaw
      # Model provider credentials (at least one required)
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      GOOGLE_AI_API_KEY: ${GOOGLE_AI_API_KEY:-}
      # Default model (optional)
      OPENCLAW_DEFAULT_MODEL: ${OPENCLAW_DEFAULT_MODEL:-}
      # Plugin configuration for openclaw-projects
      # The plugin connects to the API server for task/memory management
      OPENCLAW_PROJECTS_API_URL: http://api:3001
      OPENCLAW_API_TOKEN: ${OPENCLAW_API_TOKEN:-}
      # Channel credentials (optional - configure as needed)
      # Telegram
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-}
      # Discord
      DISCORD_BOT_TOKEN: ${DISCORD_BOT_TOKEN:-}
      DISCORD_APPLICATION_ID: ${DISCORD_APPLICATION_ID:-}
      # WhatsApp (via Twilio)
      TWILIO_ACCOUNT_SID: ${TWILIO_ACCOUNT_SID:-}
      TWILIO_AUTH_TOKEN: ${TWILIO_AUTH_TOKEN:-}
      TWILIO_WHATSAPP_NUMBER: ${TWILIO_WHATSAPP_NUMBER:-}
      # Slack
      SLACK_BOT_TOKEN: ${SLACK_BOT_TOKEN:-}
      SLACK_APP_TOKEN: ${SLACK_APP_TOKEN:-}
      SLACK_SIGNING_SECRET: ${SLACK_SIGNING_SECRET:-}
    volumes:
      # Persistent storage for agent sessions and workspace
      - openclaw_data:/home/node/.openclaw
    # Publish to localhost for Traefik (host networking mode)
    ports:
      - "[::1]:${GATEWAY_HOST_PORT:-18789}:18789"       # IPv6 (preferred)
      - "127.0.0.1:${GATEWAY_HOST_PORT:-18789}:18789"  # IPv4 fallback
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O /dev/null http://127.0.0.1:18789/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    # Container hardening
    # Note: OpenClaw runs as non-root user (node, uid 1000)
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M
    # Note: No Traefik labels - routing is handled by the file provider
    # (dynamic-config.yml.template) which routes DOMAIN/openclaw, ws.DOMAIN,
    # and hooks.DOMAIN -> gateway

  # =============================================================================
  # PromptGuard-2 (Prompt Injection Detection)
  # =============================================================================
  # Classifier service using Meta's Llama-Prompt-Guard-2-86M for multilingual
  # prompt injection and jailbreak detection. On first start, downloads the
  # model (~500MB) from HuggingFace using HF_TOKEN. Subsequent starts use the
  # cached model from the persistent volume.
  # If PromptGuard is unavailable, injection detection falls back to regex.
  prompt-guard:
    image: ghcr.io/troykelly/openclaw-projects-prompt-guard:latest
    profiles: ["ml"]
    container_name: openclaw-prompt-guard
    restart: unless-stopped
    environment:
      HF_TOKEN: ${HF_TOKEN:-}
      MODEL_CACHE_DIR: /app/model_cache
    volumes:
      - prompt_guard_model_cache:/app/model_cache
    ports:
      - "[::1]:${PROMPT_GUARD_HOST_PORT:-8190}:8190"       # IPv6 (preferred)
      - "127.0.0.1:${PROMPT_GUARD_HOST_PORT:-8190}:8190"  # IPv4 fallback
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8190/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    # Container hardening
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 1536M
        reservations:
          cpus: "0.5"
          memory: 768M

volumes:
  db_data:
  seaweedfs_data:
  nominatim_data:
  prompt_guard_model_cache:
  traefik_dynamic:
  # ModSecurity named volumes — auto-populated from the CRS image on first run.
  # Required because the CRS entrypoint modifies files that ship inside the image
  # (setup.conf, crs-setup.conf, TLS certs). A tmpfs mount hides those files.
  # NOTE: On CRS image upgrades, remove these volumes to pick up new defaults:
  #   docker compose -f docker-compose.full.yml down
  #   docker volume rm openclaw-projects_modsec_conf openclaw-projects_modsec_crs openclaw-projects_modsec_apache_conf
  modsec_conf:
  modsec_crs:
  modsec_apache_conf:
  openclaw_data:

configs:
  traefik_entrypoint:
    file: ./docker/traefik/entrypoint.sh
