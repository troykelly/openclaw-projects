# Production compose for openclaw-projects (Issue #46)
#
# Usage:
#   cp .env.example .env
#   docker compose -f docker-compose.prod.yml up -d
#   docker compose -f docker-compose.prod.yml run --rm migrate
#
name: openclaw-projects

services:
  postgres:
    build:
      context: .
      dockerfile: docker/postgres/Dockerfile
    container_name: openclaw-projects-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-openclaw}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-openclaw}
      POSTGRES_DB: ${POSTGRES_DB:-openclaw}
    # Required for some extensions (notably pg_cron and TimescaleDB)
    command:
      - postgres
      - -c
      - shared_preload_libraries=timescaledb,pg_cron
      - -c
      - cron.database_name=${POSTGRES_DB:-openclaw}
    volumes:
      - /var/project/data/openclaw-projects/postgres:/var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 10

  seaweedfs:
    image: chrislusf/seaweedfs:latest
    container_name: openclaw-projects-seaweedfs
    restart: unless-stopped
    command: "server -s3 -s3.port=8333 -ip.bind=0.0.0.0 -master.volumeSizeLimitMB=${SEAWEEDFS_VOLUME_SIZE_LIMIT_MB:-30000} -volume.max=100"
    ports:
      - "127.0.0.1:8333:8333"
    volumes:
      - /var/project/data/openclaw-projects/seaweedfs:/data
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://127.0.0.1:9333/cluster/status"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 30s
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

  projects:
    build:
      context: .
      dockerfile: docker/api/Dockerfile
    container_name: openclaw-projects
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      seaweedfs:
        condition: service_healthy
    environment:
      NODE_ENV: production
      HOST: 0.0.0.0
      PORT: 3000
      PUBLIC_BASE_URL: ${PUBLIC_BASE_URL:-http://localhost:3000}
      COOKIE_SECRET: ${COOKIE_SECRET:-}
      # DB connection (used by the API)
      PGHOST: postgres
      PGPORT: 5432
      PGUSER: ${POSTGRES_USER:-openclaw}
      PGPASSWORD: ${POSTGRES_PASSWORD:-openclaw}
      PGDATABASE: ${POSTGRES_DB:-openclaw}

      # S3-compatible storage (SeaweedFS)
      S3_ENDPOINT: http://seaweedfs:8333
      S3_BUCKET: ${S3_BUCKET:-openclaw}
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-openclaw}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-openclaw}
      S3_FORCE_PATH_STYLE: "true"

      # Email (Postmark)
      POSTMARK_FROM: ${POSTMARK_FROM:-}
      POSTMARK_REPLY_TO: ${POSTMARK_REPLY_TO:-}
      POSTMARK_MESSAGE_STREAM: ${POSTMARK_MESSAGE_STREAM:-outbound}
      POSTMARK_TRANSACTIONAL_TOKEN_FILE: ${POSTMARK_TRANSACTIONAL_TOKEN_FILE:-/run/secrets/postmark_transactional_token}
      POSTMARK_BROADCAST_TOKEN_FILE: ${POSTMARK_BROADCAST_TOKEN_FILE:-/run/secrets/postmark_broadcast_token}

    volumes:
      - /home/openclaw/.postmark_transactional_token:/run/secrets/postmark_transactional_token:ro
      - /home/openclaw/.postmark_broadcast_token:/run/secrets/postmark_broadcast_token:ro

    # Expose the service for Traefik/file-provider usage.
    # For a docker-provider Traefik setup, remove the host mapping and use a shared network + labels.
    ports:
      - "127.0.0.1:${PROJECTS_PORT:-3000}:3000"
    healthcheck:
      test: ["CMD-SHELL", "node -e \"fetch('http://127.0.0.1:3000/health').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))\"" ]
      interval: 10s
      timeout: 3s
      retries: 10

  migrate:
    build:
      context: .
      dockerfile: docker/migrate/Dockerfile
    container_name: openclaw-projects-migrate
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-openclaw}:${POSTGRES_PASSWORD:-openclaw}@postgres:5432/${POSTGRES_DB:-openclaw}?sslmode=disable
    command:
      - -path
      - /migrations
      - -database
      - postgresql://${POSTGRES_USER:-openclaw}:${POSTGRES_PASSWORD:-openclaw}@postgres:5432/${POSTGRES_DB:-openclaw}?sslmode=disable
      - up
    restart: "no"
