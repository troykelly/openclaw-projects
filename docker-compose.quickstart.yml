# =============================================================================
# openclaw-projects Quickstart Compose
# =============================================================================
#
# Minimal compose file for getting started quickly with local development
# and testing. NOT intended for production use.
#
# Included services:
#   - db        : PostgreSQL with TimescaleDB, pgvector, pg_cron
#   - seaweedfs : S3-compatible object storage
#   - migrate   : Database migrations (runs once and exits)
#   - api       : Fastify API server
#
# Prerequisites:
#   1. Run the setup script to generate a .env file:
#        ./scripts/setup.sh
#      Or in non-interactive mode:
#        ./scripts/setup.sh --non-interactive
#
#   2. Start services:
#        docker compose -f docker-compose.quickstart.yml up -d
#
#   3. API will be available at http://localhost:3000
#
# Required environment variables (set in .env or shell):
#   - POSTGRES_PASSWORD  : Database password (auto-generated by setup script)
#   - S3_SECRET_KEY      : S3 storage secret (auto-generated by setup script)
#   - COOKIE_SECRET      : Cookie signing secret (auto-generated by setup script)
#
# For production deployment, see docker-compose.yml (basic) or
# docker-compose.traefik.yml (TLS with Traefik).
# =============================================================================

name: openclaw-projects-quickstart

services:
  # ---------------------------------------------------------------------------
  # Database (PostgreSQL with TimescaleDB, pgvector, pg_cron)
  # ---------------------------------------------------------------------------
  db:
    image: ghcr.io/troykelly/openclaw-projects-db:latest
    container_name: openclaw-qs-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-openclaw}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?Set POSTGRES_PASSWORD in .env or run ./scripts/setup.sh}
      POSTGRES_DB: ${POSTGRES_DB:-openclaw}
    command:
      - postgres
      - -c
      - shared_preload_libraries=timescaledb,pg_cron
      - -c
      - cron.database_name=${POSTGRES_DB:-openclaw}
    volumes:
      - db_data:/var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER:-openclaw} -d $${POSTGRES_DB:-openclaw}"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    shm_size: 256mb

  # ---------------------------------------------------------------------------
  # SeaweedFS (S3-compatible object storage)
  # ---------------------------------------------------------------------------
  seaweedfs:
    image: chrislusf/seaweedfs:4.09
    container_name: openclaw-qs-seaweedfs
    restart: unless-stopped
    entrypoint: ["/docker-entrypoint-s3.sh"]
    environment:
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-openclaw}
      S3_SECRET_KEY: ${S3_SECRET_KEY:?Set S3_SECRET_KEY in .env or run ./scripts/setup.sh}
      SEAWEEDFS_VOLUME_SIZE_LIMIT_MB: ${SEAWEEDFS_VOLUME_SIZE_LIMIT_MB:-1000}
      SEAWEEDFS_VOLUME_MAX: ${SEAWEEDFS_VOLUME_MAX:-10}
    volumes:
      - seaweedfs_data:/data
      - ./docker/seaweedfs/s3.json.template:/etc/seaweedfs/s3.json.template:ro
      - ./docker/seaweedfs/entrypoint.sh:/docker-entrypoint-s3.sh:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://127.0.0.1:9333/cluster/status"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 30s

  # ---------------------------------------------------------------------------
  # Database Migrations (runs once and exits)
  # ---------------------------------------------------------------------------
  migrate:
    image: ghcr.io/troykelly/openclaw-projects-migrate:latest
    container_name: openclaw-qs-migrate
    restart: "no"
    depends_on:
      db:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-openclaw}:${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}@db:5432/${POSTGRES_DB:-openclaw}?sslmode=disable
    command:
      - -path
      - /migrations
      - -database
      - postgresql://${POSTGRES_USER:-openclaw}:${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}@db:5432/${POSTGRES_DB:-openclaw}?sslmode=disable
      - up

  # ---------------------------------------------------------------------------
  # API Server (Fastify)
  # ---------------------------------------------------------------------------
  api:
    image: ghcr.io/troykelly/openclaw-projects-api:latest
    container_name: openclaw-qs-api
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      seaweedfs:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      HOST: 0.0.0.0
      PORT: 3000
      PUBLIC_BASE_URL: ${PUBLIC_BASE_URL:-http://localhost:3000}
      COOKIE_SECRET: ${COOKIE_SECRET:?Set COOKIE_SECRET in .env or run ./scripts/setup.sh}
      # Database
      PGHOST: db
      PGPORT: 5432
      PGUSER: ${POSTGRES_USER:-openclaw}
      PGPASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      PGDATABASE: ${POSTGRES_DB:-openclaw}
      # S3 storage (SeaweedFS)
      S3_ENDPOINT: http://seaweedfs:8333
      S3_BUCKET: ${S3_BUCKET:-openclaw}
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-openclaw}
      S3_SECRET_KEY: ${S3_SECRET_KEY:?S3_SECRET_KEY is required}
      S3_FORCE_PATH_STYLE: "true"
      # Auth — disabled by default for quickstart; set AUTH_SECRET in .env for production
      OPENCLAW_PROJECTS_AUTH_SECRET: ${OPENCLAW_PROJECTS_AUTH_SECRET:-}
      OPENCLAW_PROJECTS_AUTH_DISABLED: ${OPENCLAW_PROJECTS_AUTH_DISABLED:-true}
      # Disable rate limiting and webhook IP whitelist for local dev
      RATE_LIMIT_DISABLED: ${RATE_LIMIT_DISABLED:-true}
      WEBHOOK_IP_WHITELIST_DISABLED: ${WEBHOOK_IP_WHITELIST_DISABLED:-true}
      # Optional — embedding (semantic search)
      EMBEDDING_PROVIDER: ${EMBEDDING_PROVIDER:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      VOYAGERAI_API_KEY: ${VOYAGERAI_API_KEY:-}
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      # Optional — OAuth integration (Microsoft 365 / Google)
      # See docs/guides/oauth-setup.md for credential setup
      MS365_CLIENT_ID: ${MS365_CLIENT_ID:-}
      MS365_CLIENT_SECRET: ${MS365_CLIENT_SECRET:-}
      AZURE_TENANT_ID: ${AZURE_TENANT_ID:-}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      OAUTH_REDIRECT_URI: ${OAUTH_REDIRECT_URI:-}
      OAUTH_TOKEN_ENCRYPTION_KEY: ${OAUTH_TOKEN_ENCRYPTION_KEY:-}
    ports:
      - "${API_PORT:-3000}:3000"
    healthcheck:
      test: ["CMD-SHELL", "node -e \"fetch('http://127.0.0.1:3000/health').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))\""]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 15s

volumes:
  db_data:
  seaweedfs_data:
