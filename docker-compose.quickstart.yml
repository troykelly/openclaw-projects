# =============================================================================
# openclaw-projects Quickstart Compose
# =============================================================================
#
# Minimal compose file for getting started quickly with local development
# and testing. NOT intended for production use.
#
# Included services:
#   - db        : PostgreSQL with TimescaleDB, pgvector, pg_cron
#   - seaweedfs : S3-compatible object storage
#   - migrate   : Database migrations (runs once and exits)
#   - api       : Fastify API server
#
# Prerequisites:
#   1. Run the setup script to generate a .env file:
#        ./scripts/setup.sh
#      Or in non-interactive mode:
#        ./scripts/setup.sh --non-interactive
#
#   2. Start services:
#        docker compose -f docker-compose.quickstart.yml up -d
#
#   3. API will be available at http://localhost:3000
#
# Required environment variables (set in .env or shell):
#   - POSTGRES_PASSWORD  : Database password (auto-generated by setup script)
#   - S3_SECRET_KEY      : S3 storage secret (auto-generated by setup script)
#   - COOKIE_SECRET      : Cookie signing secret (auto-generated by setup script)
#   - JWT_SECRET         : JWT signing secret, min 32 bytes (auto-generated by setup script)
#
# For production deployment, see docker-compose.yml (basic) or
# docker-compose.traefik.yml (TLS with Traefik).
# =============================================================================

name: openclaw-projects-quickstart

services:
  # ---------------------------------------------------------------------------
  # Database (PostgreSQL with TimescaleDB, pgvector, pg_cron)
  # ---------------------------------------------------------------------------
  db:
    image: ghcr.io/troykelly/openclaw-projects-db:latest
    container_name: openclaw-qs-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-openclaw}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?Set POSTGRES_PASSWORD in .env or run ./scripts/setup.sh}
      POSTGRES_DB: ${POSTGRES_DB:-openclaw}
    command:
      - postgres
      - -c
      - shared_preload_libraries=timescaledb,pg_cron
      - -c
      - cron.database_name=${POSTGRES_DB:-openclaw}
    volumes:
      - db_data:/var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER:-openclaw} -d $${POSTGRES_DB:-openclaw}"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    shm_size: 256mb

  # ---------------------------------------------------------------------------
  # SeaweedFS (S3-compatible object storage)
  # ---------------------------------------------------------------------------
  seaweedfs:
    image: chrislusf/seaweedfs:4.09
    container_name: openclaw-qs-seaweedfs
    restart: unless-stopped
    entrypoint: ["/docker-entrypoint-s3.sh"]
    environment:
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-openclaw}
      S3_SECRET_KEY: ${S3_SECRET_KEY:?Set S3_SECRET_KEY in .env or run ./scripts/setup.sh}
      SEAWEEDFS_VOLUME_SIZE_LIMIT_MB: ${SEAWEEDFS_VOLUME_SIZE_LIMIT_MB:-1000}
      SEAWEEDFS_VOLUME_MAX: ${SEAWEEDFS_VOLUME_MAX:-10}
    volumes:
      - seaweedfs_data:/data
      - ./docker/seaweedfs/s3.json.template:/etc/seaweedfs/s3.json.template:ro
      - ./docker/seaweedfs/entrypoint.sh:/docker-entrypoint-s3.sh:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://127.0.0.1:9333/cluster/status"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 30s

  # ---------------------------------------------------------------------------
  # Database Migrations (runs once and exits)
  # ---------------------------------------------------------------------------
  migrate:
    image: ghcr.io/troykelly/openclaw-projects-migrate:latest
    container_name: openclaw-qs-migrate
    restart: "no"
    depends_on:
      db:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-openclaw}:${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}@db:5432/${POSTGRES_DB:-openclaw}?sslmode=disable
    command:
      - -path
      - /migrations
      - -database
      - postgresql://${POSTGRES_USER:-openclaw}:${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}@db:5432/${POSTGRES_DB:-openclaw}?sslmode=disable
      - up

  # ---------------------------------------------------------------------------
  # API Server (Fastify)
  # ---------------------------------------------------------------------------
  api:
    image: ghcr.io/troykelly/openclaw-projects-api:latest
    container_name: openclaw-qs-api
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      seaweedfs:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      HOST: "::"
      PORT: 3000
      PUBLIC_BASE_URL: ${PUBLIC_BASE_URL:-http://localhost:3000}
      COOKIE_SECRET: ${COOKIE_SECRET:?Set COOKIE_SECRET in .env or run ./scripts/setup.sh}
      JWT_SECRET: ${JWT_SECRET:-}
      JWT_SECRET_PREVIOUS: ${JWT_SECRET_PREVIOUS:-}
      # Database
      PGHOST: db
      PGPORT: 5432
      PGUSER: ${POSTGRES_USER:-openclaw}
      PGPASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      PGDATABASE: ${POSTGRES_DB:-openclaw}
      # S3 storage (SeaweedFS)
      S3_ENDPOINT: http://seaweedfs:8333
      S3_BUCKET: ${S3_BUCKET:-openclaw}
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-openclaw}
      S3_SECRET_KEY: ${S3_SECRET_KEY:?S3_SECRET_KEY is required}
      S3_FORCE_PATH_STYLE: "true"
      # Auth — disabled by default for quickstart; set OPENCLAW_API_TOKEN in .env for production
      OPENCLAW_API_TOKEN: ${OPENCLAW_API_TOKEN:-}
      OPENCLAW_PROJECTS_AUTH_DISABLED: ${OPENCLAW_PROJECTS_AUTH_DISABLED:-true}
      # Disable rate limiting and webhook IP whitelist for local dev
      RATE_LIMIT_DISABLED: ${RATE_LIMIT_DISABLED:-true}
      WEBHOOK_IP_WHITELIST_DISABLED: ${WEBHOOK_IP_WHITELIST_DISABLED:-true}
      # Optional — embedding (semantic search)
      EMBEDDING_PROVIDER: ${EMBEDDING_PROVIDER:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      VOYAGERAI_API_KEY: ${VOYAGERAI_API_KEY:-}
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      # Optional — OAuth integration (Microsoft 365 / Google)
      # See docs/guides/oauth-setup.md for credential setup
      MS365_CLIENT_ID: ${MS365_CLIENT_ID:-}
      MS365_CLIENT_SECRET: ${MS365_CLIENT_SECRET:-}
      AZURE_TENANT_ID: ${AZURE_TENANT_ID:-}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      OAUTH_REDIRECT_URI: ${OAUTH_REDIRECT_URI:-}
      OAUTH_TOKEN_ENCRYPTION_KEY: ${OAUTH_TOKEN_ENCRYPTION_KEY:-}
      # Optional — Nominatim (reverse geocoding for geo-contextual search)
      NOMINATIM_URL: ${NOMINATIM_URL:-http://nominatim:8080}
    ports:
      - "[::1]:${API_PORT:-3000}:3000"       # IPv6 (preferred)
      - "127.0.0.1:${API_PORT:-3000}:3000"  # IPv4 fallback
    healthcheck:
      test: ["CMD-SHELL", "node -e \"fetch('http://127.0.0.1:3000/health').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))\""]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 15s

  # ---------------------------------------------------------------------------
  # Nominatim (Reverse Geocoding)
  # ---------------------------------------------------------------------------
  # Self-hosted OpenStreetMap geocoder for geo-contextual search features.
  # On first start, imports the PBF extract (this takes 10+ minutes depending
  # on region size). After import, the service provides fast local geocoding.
  # If Nominatim is unavailable, geo features silently degrade.
  nominatim:
    image: mediagis/nominatim:4.4
    container_name: openclaw-qs-nominatim
    restart: unless-stopped
    environment:
      # OpenStreetMap PBF extract to import
      # Find regional extracts at: https://download.geofabrik.de/
      PBF_URL: ${NOMINATIM_PBF_URL:-https://download.geofabrik.de/australia-oceania/australia-latest.osm.pbf}
      REPLICATION_URL: ${NOMINATIM_REPLICATION_URL:-https://download.geofabrik.de/australia-oceania/australia-updates/}
      NOMINATIM_PASSWORD: ${NOMINATIM_PASSWORD:-openclaw}
    volumes:
      - nominatim_data:/var/lib/postgresql/14/main
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/status"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 600s
    # Container hardening
    # Note: Nominatim runs PostgreSQL internally and requires more capabilities
    security_opt:
      - no-new-privileges:true

  # ---------------------------------------------------------------------------
  # Background Worker (job processing, notifications, embeddings)
  # ---------------------------------------------------------------------------
  worker:
    image: ghcr.io/troykelly/openclaw-projects-worker:latest
    container_name: openclaw-qs-worker
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PGHOST: db
      PGPORT: 5432
      PGUSER: ${POSTGRES_USER:-openclaw}
      PGPASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      PGDATABASE: ${POSTGRES_DB:-openclaw}
      # JWT signing (required when worker verifies tokens)
      JWT_SECRET: ${JWT_SECRET:-}
      JWT_SECRET_PREVIOUS: ${JWT_SECRET_PREVIOUS:-}
      # Optional — embedding (semantic search)
      EMBEDDING_PROVIDER: ${EMBEDDING_PROVIDER:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      VOYAGERAI_API_KEY: ${VOYAGERAI_API_KEY:-}
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:9000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # ---------------------------------------------------------------------------
  # PromptGuard-2 (Prompt Injection Detection)
  # ---------------------------------------------------------------------------
  # Classifier service using Meta's Llama-Prompt-Guard-2-86M for multilingual
  # prompt injection and jailbreak detection. On first start, downloads the
  # model (~500MB) from HuggingFace using HF_TOKEN. Subsequent starts use the
  # cached model from the persistent volume.
  # If PromptGuard is unavailable, injection detection falls back to regex.
  prompt-guard:
    image: ghcr.io/troykelly/openclaw-projects-prompt-guard:latest
    profiles: ["ml"]
    container_name: openclaw-qs-prompt-guard
    restart: unless-stopped
    environment:
      HF_TOKEN: ${HF_TOKEN:-}
      MODEL_CACHE_DIR: /app/model_cache
    volumes:
      - prompt_guard_model_cache:/app/model_cache
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8190/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    # Container hardening
    security_opt:
      - no-new-privileges:true

volumes:
  db_data:
  seaweedfs_data:
  nominatim_data:
  prompt_guard_model_cache:
